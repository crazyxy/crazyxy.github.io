<!doctype html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Lato:300,300italic,400,400italic,700,700italic|Lato:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="Crazyxy is Coding">
<meta property="og:url" content="https://crazyxy.github.io/index.html">
<meta property="og:site_name" content="Crazyxy is Coding">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Crazyxy is Coding">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"remove","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://crazyxy.github.io/"/>





  <title>Crazyxy is Coding</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Crazyxy is Coding</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://crazyxy.github.io/2017/06/21/Codeforces-419 Div 2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yan Xue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Crazyxy is Coding">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/21/Codeforces-419 Div 2/" itemprop="url">Codeforces Round &#35; 419 (Div 2)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-21T22:41:47+08:00">
                2017-06-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/21/Codeforces-419 Div 2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/06/21/Codeforces-419 Div 2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://codeforces.com/contest/816" target="_blank" rel="external">题目链接</a></p>
<ul>
<li><p>A. Karen and Morning</p>
<ul>
<li>思路：直接模拟</li>
<li>代码：<a href="http://codeforces.com/contest/816/submission/27853896" target="_blank" rel="external">http://codeforces.com/contest/816/submission/27853896</a></li>
</ul>
</li>
<li><p>B. Karen and Coffee</p>
<ul>
<li>思路：直接计算每个点由多少线段覆盖。计算时先将线段分别按照左右端点排序，然后使用二分查找。计算完之后用前缀的数组和记录i之前的所有的满足条件的点的个数，每次查询可以在<code>O(1)</code>的时间复杂度之内给出答案</li>
<li>代码：<a href="http://codeforces.com/contest/816/submission/27860856" target="_blank" rel="external">http://codeforces.com/contest/816/submission/27860856</a></li>
</ul>
</li>
<li><p>C. Karen and Game</p>
<ul>
<li>思路：如果行数大于列数，则优先消列，否则先逐行的消除。然后简单模拟即可</li>
<li>代码：<a href="http://codeforces.com/contest/816/submission/27938174" target="_blank" rel="external">http://codeforces.com/contest/816/submission/27938174</a></li>
</ul>
</li>
<li><p>D. Karen and Test</p>
<ul>
<li>思路：假设初始状态第一行的个数为<code>n</code>，首先如果<code>n</code>小于等于3，直接暴力计算即可。如果<code>n</code>大于3，则需要另寻他法。通过多次观察可以发现，如果<code>n</code>为偶数，则最终的结果为奇数位与二项式系数的点积 <code>+ or -</code> 偶数位与二项式系数的点积。题目在计算组合数的时候，为了计算$$C^m_n=\frac{n!}{m!(n-m)!}$$，使用了费马小定理快速求逆。如果<code>n</code>是奇数，则先将<code>n</code>转化成偶数，然后在计算。</li>
<li>代码：<a href="http://codeforces.com/contest/816/submission/27941712" target="_blank" rel="external">http://codeforces.com/contest/816/submission/27941712</a></li>
</ul>
</li>
<li><p>E. Karen and Supermarket</p>
<ul>
<li>思路：树形动态规划，难哭了。首先根据折扣使用先后情况建立树。然后建立状态<code>dp[u][i+j][0] or dp[u][i+j][1]</code>，表示以<code>u</code>为根共购买<code>i+j</code>件商品且在第<code>u</code>件使用了或者没有使用优惠券的最低价格。状态转移如下：$$dp[u][i+j][0] = min(dp[u][i+j][0], dp[u][i][0]+dp[v][j][0]$$，$$dp[u][i+j][1] = min(dp[u][i+j][1], min(dp[u][i][1]+dp[v][j][1], dp[u][i][1]+dp[v][j][0])$$。注意更新状态的时候<code>u</code>要从大到小更新。</li>
<li>代码：<a href="http://codeforces.com/contest/816/submission/27948010" target="_blank" rel="external">http://codeforces.com/contest/816/submission/27948010</a></li>
</ul>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://crazyxy.github.io/2017/05/13/LevelDB-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yan Xue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Crazyxy is Coding">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/13/LevelDB-3/" itemprop="url">LevelDB IV</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-13T21:54:00+08:00">
                2017-05-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/13/LevelDB-3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/05/13/LevelDB-3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>This post explains the the <code>LRUCache</code> in LevelDB.</p>
<h2 id="1-Cache-interface"><a href="#1-Cache-interface" class="headerlink" title="1. Cache interface"></a>1. <code>Cache</code> interface</h2><p><code>Cache</code> locates in <em>include/leveldb/cache.h</em>. In provides following virtual functions:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Handle* Insert(const Slice&amp; key, void* value, size_t charge, void (*deleter)(const Slice&amp; key, void* value))</div><div class="line">Handle* Lookup(const Slice&amp; key)</div><div class="line">void Release(Handle* handle)</div><div class="line">void* Value(Handle* handle)</div><div class="line">void Erase(const Slice&amp; key)</div><div class="line">uint64_t NewId()</div><div class="line">void Prune()</div><div class="line">size_t TotalCharge()</div></pre></td></tr></table></figure>
<p>The implementations and usage of each function will be explained in the later sections.</p>
<h2 id="2-CacheHandle-implementation"><a href="#2-CacheHandle-implementation" class="headerlink" title="2. CacheHandle implementation"></a>2. <code>CacheHandle</code> implementation</h2><p>Before diving into the <code>LRUCache</code>, I will introduce the <code>LRUHandle</code> first, which is the entry in the <code>LRUCache</code>. <code>LRUCache</code> is commonly implemented by a hash table and a double linked lisk. The <code>LRUHandle</code> is defined as:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">LRUHandle</span>&#123;</span></div><div class="line">    <span class="keyword">void</span> *value;</div><div class="line">    <span class="keyword">void</span> (*deleter)(<span class="keyword">const</span> Slice&amp;, <span class="keyword">void</span>* value);</div><div class="line">    LRUHandle *next_hash; <span class="comment">//next element in the hash table</span></div><div class="line">    LRUHandle *next; <span class="comment">//next element in the double linked list</span></div><div class="line">    LRUHandle *prev; <span class="comment">//previous element in the double linked list</span></div><div class="line">    <span class="keyword">size_t</span> charge; <span class="comment">//sizeof the LRUHandle</span></div><div class="line">    <span class="keyword">size_t</span> key_length;</div><div class="line">    <span class="keyword">bool</span> in_cache;</div><div class="line">    <span class="keyword">uint32_t</span> refs;</div><div class="line">    <span class="keyword">uint32_t</span> hash;</div><div class="line">    <span class="keyword">char</span> key_data[<span class="number">1</span>]; <span class="comment">//placeholder for key_data</span></div><div class="line"></div><div class="line">    <span class="function">Slice <span class="title">key</span><span class="params">()</span> <span class="keyword">const</span></span>&#123;</div><div class="line">        <span class="keyword">if</span> (next == <span class="keyword">this</span>)&#123;</div><div class="line">            <span class="keyword">return</span> *(<span class="keyword">reinterpret_cast</span>&lt;Slice*&gt;(value));</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">return</span> Slice(key_data, key_length);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-HandleTable-implementation"><a href="#3-HandleTable-implementation" class="headerlink" title="3. HandleTable implementation"></a>3. <code>HandleTable</code> implementation</h2><p><code>HandleTable</code> is the hash table used for <code>LRUCache</code>. Three public interfaces all depends on the function <code>FindPointer</code>, which is defined as:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function">LRUHandle** <span class="title">FindPointer</span><span class="params">(<span class="keyword">const</span> Slice&amp; key, <span class="keyword">uint32_t</span> hash)</span> </span>&#123;</div><div class="line">    LRUHandle** ptr = &amp;list_[hash &amp; (length_ - <span class="number">1</span>)];</div><div class="line">    <span class="keyword">while</span> (*ptr != <span class="literal">NULL</span> &amp;&amp; ((*ptr)-&gt;hash != hash || key != (*ptr)-&gt;key())) &#123;</div><div class="line">      ptr = &amp;(*ptr)-&gt;next_hash;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ptr;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>FindPointer</code> tries to find a entry in the <code>list_</code>. If there is no such entry, it will return <code>NULL</code>, otherwise it returns the entry. There are three things we should notice here:</p>
<ol>
<li>The hash function used for hash table is <code>hash &amp; (length - 1)</code> which equals to <code>hash % length</code>;</li>
<li><code>FindPointer</code> returns a pointer to either the pointer who points to the specific entry or <code>NULL</code>;</li>
<li><code>FindPointer</code> returns a double pointers.</li>
</ol>
<p>The third point is very important. Let’s take a look at <code>Insert</code> and <code>Remove</code> implementation in <code>HandleTable</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function">LRUHandle* <span class="title">Insert</span><span class="params">(LRUHandle* h)</span> </span>&#123;</div><div class="line">    LRUHandle** ptr = FindPointer(h-&gt;key(), h-&gt;hash);</div><div class="line">    LRUHandle* old = *ptr;</div><div class="line">    h-&gt;next_hash = (old == <span class="literal">NULL</span> ? <span class="literal">NULL</span> : old-&gt;next_hash);</div><div class="line">    *ptr = h;</div><div class="line">    <span class="keyword">if</span> (old == <span class="literal">NULL</span>) &#123;</div><div class="line">        ++elems_;</div><div class="line">        <span class="keyword">if</span> (elems_ &gt; length_) &#123;</div><div class="line">            Resize();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> old;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>This piece of code inserts an handle into hash table and return the old handle. <code>h-&gt;next_hash = (old == NULL ? NULL : old-&gt;next_hash)</code> sets the next element in the hash table. <code>*ptr=h</code> is very tricky. It chains <code>h</code> in the hash table. <code>**ptr</code> is the address of the last <code>LRUHandle</code>‘s <code>next_hash</code>. Therefore <code>*ptr=h</code> sets the address of <code>h</code> to the <code>next_hash</code>. By this way, <code>h</code> is inserted into the hash table.</p>
<p><code>Remove</code> uses the same method for removing an element from the hash table.</p>
<h2 id="4-LRUCache-implementation"><a href="#4-LRUCache-implementation" class="headerlink" title="4. LRUCache implementation"></a>4. <code>LRUCache</code> implementation</h2><p><code>ShardedLRUCache</code> <em>has a</em> <code>LRUCache</code> object and <code>ShardedLRUCache</code> <em>is a</em> <code>Cache</code>. The functions in <code>ShardedLRUCache</code> are all implementated by <code>LRUCache</code>. </p>
<p>In <code>LRUCache</code>, there are two double linked lists, <code>lru_</code> and <code>in_use</code>. Both of them are initialized with a dummy head whose <code>next</code> and <code>prev</code> pointers point to themselves. </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">LRUCache::LRUCache() : usage_(<span class="number">0</span>) &#123;</div><div class="line">    lru_.next = &amp;lru_;</div><div class="line">    lru_.prev = &amp;lru_;</div><div class="line">    in_use_.next = &amp;in_use_;</div><div class="line">    in_use_.prev = &amp;in_use_;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">Cache::Handle* LRUCache::Insert(<span class="keyword">const</span> Slice&amp; key, <span class="keyword">uint32_t</span> hash, <span class="keyword">void</span>* value, <span class="keyword">size_t</span> charge, <span class="keyword">void</span> (*deleter)(<span class="keyword">const</span> Slice&amp; key, <span class="keyword">void</span>* value)) &#123;</div><div class="line">    <span class="function">MutexLock <span class="title">l</span><span class="params">(&amp;mutex_)</span></span>;</div><div class="line">    </div><div class="line">    LRUHandle* e = <span class="keyword">reinterpret_cast</span>&lt;LRUHandle*&gt;(<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(LRUHandle)<span class="number">-1</span> + key.size()));</div><div class="line">    e-&gt;value = value;</div><div class="line">    e-&gt;deleter = deleter;</div><div class="line">    e-&gt;charge = charge;</div><div class="line">    e-&gt;key_length = key.size();</div><div class="line">    e-&gt;hash = hash;</div><div class="line">    e-&gt;in_cache = <span class="literal">false</span>;</div><div class="line">    e-&gt;refs = <span class="number">1</span>; </div><div class="line">    <span class="built_in">memcpy</span>(e-&gt;key_data, key.data(), key.size());</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (capacity_ &gt; <span class="number">0</span>) &#123;</div><div class="line">        e-&gt;refs++;</div><div class="line">        e-&gt;in_cache = <span class="literal">true</span>;</div><div class="line">        LRU_Append(&amp;in_use_, e);</div><div class="line">        usage_ += charge;</div><div class="line">        FinishErase(table_.Insert(e));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (usage_ &gt; capacity_ &amp;&amp; lru_.next != &amp;lru_) &#123;</div><div class="line">        LRUHandle* old = lru_.next;</div><div class="line">        assert(old-&gt;refs == <span class="number">1</span>);</div><div class="line">        <span class="keyword">bool</span> erased = FinishErase(table_.Remove(old-&gt;key(), old-&gt;hash));</div><div class="line">        <span class="keyword">if</span> (!erased) &#123;  <span class="comment">// to avoid unused variable when compiled NDEBUG</span></div><div class="line">            assert(erased);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;Cache::Handle*&gt;(e);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">bool</span> LRUCache::FinishErase(LRUHandle* e) &#123;</div><div class="line">    <span class="keyword">if</span> (e != <span class="literal">NULL</span>) &#123;</div><div class="line">        assert(e-&gt;in_cache);</div><div class="line">        LRU_Remove(e);</div><div class="line">        e-&gt;in_cache = <span class="literal">false</span>;</div><div class="line">        usage_ -= e-&gt;charge;</div><div class="line">        Unref(e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> e != <span class="literal">NULL</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The above code snippet is the insert of the <code>LRUCache</code>. Initially, the <code>refs</code> of <code>Handler</code> is set to 1 and if cache is enabled, <code>e-&gt;ref</code> and <code>e-&gt;in_cache</code> will change. <code>FinishErase</code> appears twice in this function. It removes elements which have been removed from hash table from the cache. The first <code>FinishErase</code> removes duplicate handle with the same key and the second <code>FinishErase</code> removes redundant elements from the <code>lru</code> to save memory.</p>
<h2 id="5-ShardedLRUCache-implementation"><a href="#5-ShardedLRUCache-implementation" class="headerlink" title="5. ShardedLRUCache implementation"></a>5. <code>ShardedLRUCache</code> implementation</h2><p><code>ShardedLRUCache</code> uses multiple <code>LRUCache</code> for load balance. There are totally 16 shards i.e. 16 <code>LRUCache</code> objects. <code>ShardedLRUCache</code> uses corresponding <code>LRUCache</code> method. For example, <code>Insert</code> in <code>ShardedLRUCache</code> is defined as:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">static inline uint32_t HashSlice(const Slice&amp; s) &#123;</div><div class="line">    return Hash(s.data(), s.size(), 0);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static uint32_t Shard(uint32_t hash) &#123;</div><div class="line">    return hash &gt;&gt; (32 - kNumShardBits);</div><div class="line">&#125;</div><div class="line"></div><div class="line">virtual Handle* Insert(const Slice&amp; key, void* value, size_t charge, void (*deleter)(const Slice&amp; key, void* value)) &#123;</div><div class="line">    const uint32_t hash = HashSlice(key);</div><div class="line">    return shard_[Shard(hash)].Insert(key, hash, value, charge, deleter);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The first step is to find the correpsonding shard by hash value of key. The hash value if the first 4 bits of the hash value of key.</p>
<h2 id="6-Mutex"><a href="#6-Mutex" class="headerlink" title="6. Mutex"></a>6. Mutex</h2><p>Another topic of this blog is about <code>MutexLock</code>. It is a RAII implementation, i.e., when <code>MutexLock</code> object is initialized, it gets a <code>mutex</code>, which will be release when the object is destroyed. Autoptr in C++ is a similar case. </p>
<hr>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Progress (=========&gt;                                                  ?%):</span></div><div class="line"></div><div class="line">| - arena.&#123;h,cc&#125;         ------ Done</div><div class="line">| - bloom.cc             ------ Done</div><div class="line">| - cache.cc             ------ Done</div><div class="line">| - coding.&#123;h,cc&#125;</div><div class="line">| - comparator.h</div><div class="line">| - crc32c.&#123;h,cc&#125;</div><div class="line">| - env.cc</div><div class="line">| - env_posix.cc</div><div class="line">| - filter_policy.cc     ------ Done</div><div class="line">| - hash.&#123;h,cc&#125;          ------ Done</div><div class="line">| - histogram.&#123;h,cc&#125;</div><div class="line">| - logging.&#123;h,cc&#125;</div><div class="line">| - mutexlock.h          ------ Done</div><div class="line">| - options.cc</div><div class="line">| - posix_logger.h</div><div class="line">| - random.h</div><div class="line">| - status.cc</div><div class="line">| ...</div></pre></td></tr></table></figure>
<hr>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://crazyxy.github.io/2017/05/11/LevelDB-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yan Xue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Crazyxy is Coding">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/11/LevelDB-2/" itemprop="url">LevelDB III</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-11T21:02:00+08:00">
                2017-05-11
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/11/LevelDB-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/05/11/LevelDB-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-Util-structure"><a href="#1-Util-structure" class="headerlink" title="1. Util structure"></a>1. <code>Util</code> structure</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">| - arena.&#123;h,cc&#125;         ------ Done</div><div class="line">| - bloom.cc</div><div class="line">| - cache.cc</div><div class="line">| - coding.&#123;h,cc&#125;</div><div class="line">| - comparator.h</div><div class="line">| - crc32c.&#123;h,cc&#125;</div><div class="line">| - env.cc</div><div class="line">| - env_posix.cc</div><div class="line">| - filter_policy.cc</div><div class="line">| - hash.&#123;h,cc&#125;</div><div class="line">| - histogram.&#123;h,cc&#125;</div><div class="line">| - logging.&#123;h,cc&#125;</div><div class="line">| - mutexlock.h</div><div class="line">| - options.cc</div><div class="line">| - posix_logger.h</div><div class="line">| - random.h</div><div class="line">| - status.cc</div><div class="line">| ...</div></pre></td></tr></table></figure>
<p>This post tries to explain <code>bloom filter</code> in LevelDB. The theory and proof about bloom filter can be found <a href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank" rel="external">here</a>.</p>
<h2 id="2-Bloom-Filter-introduction"><a href="#2-Bloom-Filter-introduction" class="headerlink" title="2. Bloom Filter introduction"></a>2. <code>Bloom Filter</code> introduction</h2><p><em>Bloom Filter</em> is used for checking whether an element is in the set. Bloom filter is based on a group of $k$ hash functions, which map an element to $k$ values in a bit array. False positive matches are possible, but false negtive are not - in other words, a query returns either “possibly in set” or “definitely not in set”.</p>
<h2 id="3-bloom-cc-implementation"><a href="#3-bloom-cc-implementation" class="headerlink" title="3. bloom.cc implementation"></a>3. <code>bloom.cc</code> implementation</h2><h3 id="3-1-unnamed-namespace"><a href="#3-1-unnamed-namespace" class="headerlink" title="3.1 unnamed namespace"></a>3.1 unnamed namespace</h3><blockquote>
<p>When definitions in a .cc file do not need to be referenced outside that file, place them in an unnamed namespace or declare them static. Do not use either of these constructs in .h files. — From Google C++ Style Guide</p>
</blockquote>
<p>More details about unnamed namespace is <a href="http://www.comeaucomputing.com/techtalk/#nostatic" target="_blank" rel="external">here</a>. </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> &#123;</div><div class="line">    <span class="function"><span class="keyword">static</span> uint32_t <span class="title">BloomHash</span><span class="params">(<span class="keyword">const</span> Slice&amp; key)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Hash(key.data(), key.size(), <span class="number">0xbc9f1d34</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The unnamed namespace makes BloomHash local in file <code>bloom.cc</code>. <code>BloomHash</code> returns hash value of the <code>key</code> which is a <code>Slice</code> structure. <code>BloomHash</code> calls <code>Hash</code> in <code>hash.{h,cc}</code>. </p>
<p>LevelDB uses the hash function similar to murmur hash (excerpt from comments) and it is too complex for me to understand why murmur is a good hash function. But I don’t think not knowing the detail of murmur hash can affect the understanding of LevelDB. We only need to remember that <em>LevelDB uses a highly efficient hash function</em>, you don’t even need to remember the name. Haha. </p>
<h3 id="3-2-FilterPolicy-interface"><a href="#3-2-FilterPolicy-interface" class="headerlink" title="3.2 FilterPolicy interface"></a>3.2 <code>FilterPolicy</code> interface</h3><p><code>FilterPolicy</code> contains one virtual destructor and three pure virtual functions:</p>
<ul>
<li><code>virtual const char* Name() const = 0;</code></li>
<li><code>virtual void CreateFilter(const Slice* keys, int n, std::string* dst) const = 0;</code></li>
<li><code>virtual bool KeyMayMatch(const Slice&amp; key, const Slice&amp; filter) const = 0;</code></li>
</ul>
<p><code>Name()</code> returns the name of pllicy. <code>CreateFilter</code> appends a filter that summarizes keys[0,n-1] to *dst. <code>KeyMayMatch</code> is used for determine whether key is in the keys passed by <code>CreateFilter</code>.</p>
<h3 id="3-3-BloomFilterPolicy-implementation"><a href="#3-3-BloomFilterPolicy-implementation" class="headerlink" title="3.3 BloomFilterPolicy implementation"></a>3.3 <code>BloomFilterPolicy</code> implementation</h3><p><code>CreateFilter</code> hashes $n$ <code>keys</code> into the a bit array which is appened to <code>dst</code>. The structure of <code>dst</code> is:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">|-----------------------| <span class="number">0</span></div><div class="line">| Initial dst           |</div><div class="line">|-----------------------| init_size</div><div class="line">| filter <span class="number">1</span>              |</div><div class="line">| filter <span class="number">2</span>              |</div><div class="line">| ...                   |</div><div class="line">| filter n              |</div><div class="line">|-----------------------| init_size + bytes</div><div class="line">| k_, <span class="meta"># of probes       | init_size + bytes + 1</span></div><div class="line">|-----------------------|</div></pre></td></tr></table></figure></p>
<p><code>bytes</code> is the size of filters. </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">size_t</span> bits = n * bits_per_key_;</div><div class="line"><span class="keyword">if</span> (bits &lt; <span class="number">64</span>) bits = <span class="number">64</span>;</div><div class="line"><span class="keyword">size_t</span> bytes = (bits + <span class="number">7</span>) / <span class="number">8</span>;</div></pre></td></tr></table></figure>
<p>Blool filter uses double-hashing to generate a sequence of hash values:<br>$$\mathcal{H}(x)=H_1(x)+iH_2(x)$$<br>where $H_1(x)=BloomHash(x)$ and $H_2(x)=((H_1(x)&gt;&gt;17) | (H_1(x)&lt;&lt;15))$</p>
<p>The core of <code>CreateFilter</code> is:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">    <span class="keyword">uint32_t</span> h = BloomHash(keys[i]);</div><div class="line">    <span class="keyword">const</span> <span class="keyword">uint32_t</span> delta = (h &gt;&gt; <span class="number">17</span>) | (h &lt;&lt; <span class="number">15</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> j = <span class="number">0</span>; j &lt; k_; j++) &#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">uint32_t</span> bitpos = h % bits;</div><div class="line">        <span class="built_in">array</span>[bitpos/<span class="number">8</span>] |= (<span class="number">1</span> &lt;&lt; (bitpos % <span class="number">8</span>));</div><div class="line">        h += delta;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The outer loop iterates all the keys and the inter loop does <code>k_</code> times probes for each key and uses double-hashing explained before. </p>
<p>The <code>KeyMayMatch</code> does the opposite operation of <code>CreateFilter</code> and I ignore here.</p>
<hr>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Progress (======&gt;                                                     ?%):</span></div><div class="line"></div><div class="line">| - arena.&#123;h,cc&#125;         ------ Done</div><div class="line">| - bloom.cc             ------ Done</div><div class="line">| - cache.cc</div><div class="line">| - coding.&#123;h,cc&#125;</div><div class="line">| - comparator.h</div><div class="line">| - crc32c.&#123;h,cc&#125;</div><div class="line">| - env.cc</div><div class="line">| - env_posix.cc</div><div class="line">| - filter_policy.cc     ------ Done</div><div class="line">| - hash.&#123;h,cc&#125;          ------ Done</div><div class="line">| - histogram.&#123;h,cc&#125;</div><div class="line">| - logging.&#123;h,cc&#125;</div><div class="line">| - mutexlock.h</div><div class="line">| - options.cc</div><div class="line">| - posix_logger.h</div><div class="line">| - random.h</div><div class="line">| - status.cc</div><div class="line">| ...</div></pre></td></tr></table></figure>
<hr>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://crazyxy.github.io/2017/05/07/LevelDB-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yan Xue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Crazyxy is Coding">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/07/LevelDB-1/" itemprop="url">LevelDB II</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-07T22:02:00+08:00">
                2017-05-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/07/LevelDB-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/05/07/LevelDB-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-Util-structure"><a href="#1-Util-structure" class="headerlink" title="1. Util structure"></a>1. <code>Util</code> structure</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">| - arena.&#123;h,cc&#125;</div><div class="line">| - bloom.cc</div><div class="line">| - cache.cc</div><div class="line">| - coding.&#123;h,cc&#125;</div><div class="line">| - comparator.h</div><div class="line">| - crc32c.&#123;h,cc&#125;</div><div class="line">| - env.cc</div><div class="line">| - env_posix.cc</div><div class="line">| - filter_policy.cc</div><div class="line">| - hash.&#123;h,cc&#125;</div><div class="line">| - histogram.&#123;h,cc&#125;</div><div class="line">| - logging.&#123;h,cc&#125;</div><div class="line">| - mutexlock.h</div><div class="line">| - options.cc</div><div class="line">| - posix_logger.h</div><div class="line">| - random.h</div><div class="line">| - status.cc</div><div class="line">| ...</div></pre></td></tr></table></figure>
<p>Main files in <code>util</code> are listed. Each of following sections correspond to a entry in the structure. </p>
<h2 id="2-Arena"><a href="#2-Arena" class="headerlink" title="2. Arena"></a>2. <code>Arena</code></h2><p><code>Arena</code> appears in many open source project. It’s used for memory allocation and deallocation. The implementation for <code>Arena</code> is</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Arena</span>&#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    Arena();</div><div class="line">    ~Arena();</div><div class="line">    <span class="function"><span class="keyword">char</span>* <span class="title">Allocate</span><span class="params">(<span class="keyword">size_t</span> bytes)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">char</span>* <span class="title">AllocateAligned</span><span class="params">(<span class="keyword">size_t</span> bytes)</span></span>;</div><div class="line">    </div><div class="line">    <span class="keyword">size_t</span> MemoryUsage() <span class="keyword">const</span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(memory_usage_.NoBarrier_Load());</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="function"><span class="keyword">char</span>* <span class="title">AllocateFallback</span><span class="params">(<span class="keyword">size_t</span> bytes)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">char</span>* <span class="title">AllocateNewBlock</span><span class="params">(<span class="keyword">size_t</span> block_types)</span></span>;</div><div class="line">    </div><div class="line">    <span class="keyword">char</span>* alloc_ptr;</div><div class="line">    <span class="keyword">size_t</span> alloc_bytes_remaining_;</div><div class="line"></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">char</span>*&gt; blocks_;</div><div class="line"></div><div class="line">    port::AtomicPointer memory_usage_;</div><div class="line"></div><div class="line">    Arena(<span class="keyword">const</span> Arena&amp;);</div><div class="line">    <span class="keyword">void</span> <span class="keyword">operator</span>=(<span class="keyword">const</span> Arena&amp;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">inline</span> <span class="keyword">char</span>* Arena::Allocate(<span class="keyword">size_t</span> bytes)&#123;</div><div class="line">    assert(bytes&gt;=<span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (bytes &lt;= alloc_bytes_remaining_)&#123;</div><div class="line">        <span class="keyword">char</span>* result = alloc_ptr_;</div><div class="line">        alloc_ptr_ += bytes;</div><div class="line">        alloc_bytes_remaining -= bytes;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> AllocateFallback(bytes);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Two functions (<code>Allocate</code> and <code>MemoryUsage</code>) are <code>inlined</code>. <code>MemoryUsage</code> returns the data member <code>memory_usage_</code>, which is shared by many threads. The implementation here is a thread unsafe way using <code>NoBarrier_Load</code>. I will discuss this part in the future <code>port</code> modules. Here, we discuss <code>Allocate</code> in detail. </p>
<p>If the remaining space is enough for request bytes, <code>Arena</code> only needs to update <code>alloc_ptr_</code> and <code>alloc_bytes_remaining</code>; otherwise it will call <code>AllocateFallback</code>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> in kBlockSize = <span class="number">4096</span>;</div><div class="line"></div><div class="line"><span class="keyword">char</span>* Arena::AllocateFallback(<span class="keyword">size_t</span> bytes)&#123;</div><div class="line">    <span class="keyword">if</span> (bytes &gt; kBlockSize / <span class="number">4</span>)&#123;</div><div class="line">        <span class="keyword">char</span>* result = AllocateNewBlock(bytes);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;    </div><div class="line">    alloc_ptr_ = AllocateNewBlock(kBlockSize);</div><div class="line">    alloc_bytes_remaining_ = kBlockSize;</div><div class="line"></div><div class="line">    <span class="keyword">char</span>* result  = alloc_ptr_;</div><div class="line">    alloc_ptr_ += bytes;</div><div class="line">    alloc_bytes_remaining_ -= bytes;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">char</span>* Arena::AllocateNewBlock(<span class="keyword">size_t</span> block_bytes)&#123;</div><div class="line">    <span class="keyword">char</span>* result = <span class="keyword">new</span> <span class="keyword">char</span>[block_bytes];</div><div class="line">    blocks_.push_back(result);</div><div class="line">    memory_usage_.NoBarrier_Store(</div><div class="line">        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>*&gt;(MemoryUsage() + block_bytes + <span class="keyword">sizeof</span>(<span class="keyword">char</span>*)));</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>AllocateFallback</code> calls <code>AllocateNewBlock</code> to allocate a new block and the size of the block depends of the request bytes. <code>AllocateNewBlock</code> allocates a block with provided block size and then updates the <code>memory_usage_</code>. The memory usage includes three parts: </p>
<ul>
<li>Previous memory usage (<code>MemoryUsage()</code>)</li>
<li>Block size (<code>block_bytes</code>)</li>
<li>Block pointer stored in <code>blocks_</code> (<code>sizeof(char*</code>))</li>
</ul>
<p>The last function is <code>AllocateAligned</code> which allocates aligned memory.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span>* Arena::AllocateAligned(<span class="keyword">size_t</span> bytes)&#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> align = (<span class="keyword">sizeof</span>(<span class="keyword">void</span>*) &gt; <span class="number">8</span>) ? <span class="keyword">sizeof</span>(<span class="keyword">void</span>*) : <span class="number">8</span>;</div><div class="line">    <span class="keyword">size_t</span> current_mod = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(alloc_ptr_) &amp; (align<span class="number">-1</span>);</div><div class="line">    <span class="keyword">size_t</span> slop = (current_mod == <span class="number">0</span> ? <span class="number">0</span> : align - current_mod);</div><div class="line">    <span class="keyword">size_t</span> needed = bytes + slop;</div><div class="line">    <span class="keyword">char</span>* result;</div><div class="line">    <span class="keyword">if</span> (needed &lt;= alloc_bytes_remaining_) &#123;</div><div class="line">        result = alloc_ptr_ + slop;</div><div class="line">        alloc_ptr_ += needed;</div><div class="line">        alloc_bytes_remaining_ -= needed;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        result = AllocateFallback(bytes);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>AllocateAligned</code> calculates <code>align</code> firstly and then adds <code>slop</code> to <code>bytes</code> as <code>needed</code> for alignment. Then following steps are the same as <code>Allocate</code>.</p>
<hr>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Progress (===&gt;                                                        ?%):</span></div><div class="line"></div><div class="line">| - arena.&#123;h,cc&#125;         ------ Done</div><div class="line">| - bloom.cc</div><div class="line">| - cache.cc</div><div class="line">| - coding.&#123;h,cc&#125;</div><div class="line">| - comparator.h</div><div class="line">| - crc32c.&#123;h,cc&#125;</div><div class="line">| - env.cc</div><div class="line">| - env_posix.cc</div><div class="line">| - filter_policy.cc</div><div class="line">| - hash.&#123;h,cc&#125;</div><div class="line">| - histogram.&#123;h,cc&#125;</div><div class="line">| - logging.&#123;h,cc&#125;</div><div class="line">| - mutexlock.h</div><div class="line">| - options.cc</div><div class="line">| - posix_logger.h</div><div class="line">| - random.h</div><div class="line">| - status.cc</div><div class="line">| ...</div></pre></td></tr></table></figure>
<hr>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://crazyxy.github.io/2017/05/07/leveldb-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yan Xue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Crazyxy is Coding">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/07/leveldb-0/" itemprop="url">LevelDB I</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-07T00:00:00+08:00">
                2017-05-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/07/leveldb-0/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/05/07/leveldb-0/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-LevelDB"><a href="#1-LevelDB" class="headerlink" title="1. LevelDB"></a>1. LevelDB</h2><blockquote>
<p>LevelDB is a fast key-value storage library written at Google that provides an ordered mapping from string keys to string values.</p>
</blockquote>
<p>LevelDB provides many features, such as</p>
<blockquote>
<ul>
<li>Keys and values are arbitrary byte arrays. </li>
<li>Data is stored sorted by key.</li>
<li>Callers can provide a custom comparison function to override the sort order.<br>…</li>
</ul>
</blockquote>
<p>The following few blogs are trying to explain readers the code of LevelDB, which contains the design principals of k-v store.</p>
<h2 id="2-Level-Structure"><a href="#2-Level-Structure" class="headerlink" title="2. Level Structure"></a>2. Level Structure</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">| - db </div><div class="line">| - helps</div><div class="line">|     | - memenv</div><div class="line">| - include</div><div class="line">|     | - leveldb</div><div class="line">| - port</div><div class="line">| - table</div><div class="line">| - util</div><div class="line">| ...</div></pre></td></tr></table></figure>
<p>The structure lists the main components of LevelDB. <code>db</code> folder contains db implementations. <code>memenv</code> folder contains the environment related implementations. <code>include</code> is the folder of header files. <code>port</code> contains interfaces and implementations that isolate the rest of the package from platform details. <code>table</code> contains lower level implementations. <code>util</code> contains utilities for other classes. </p>
<p><code>util</code> is much easier than other modules and doesn’t need any knowledge of kv store, so we will learn <code>util</code> firstly.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://crazyxy.github.io/2016/10/19/LeetCode-218-The-Skyline-Problem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yan Xue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Crazyxy is Coding">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/19/LeetCode-218-The-Skyline-Problem/" itemprop="url">LeetCode 218 - The Skyline Problem</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-19T16:32:13+08:00">
                2016-10-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/19/LeetCode-218-The-Skyline-Problem/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/10/19/LeetCode-218-The-Skyline-Problem/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>Segment tree update and query.</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> L(u) u&lt;&lt;1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> R(u) u&lt;&lt;1|1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MID(l,r) (l+r)&gt;&gt;1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 20010</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span>&#123;</span></div><div class="line">    <span class="keyword">int</span> l, r, h;</div><div class="line">    <span class="keyword">bool</span> lazy;</div><div class="line">&#125; nodes[MAXN&lt;&lt;<span class="number">2</span>];</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SegTree</span>&#123;</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> right, <span class="keyword">int</span> u)</span></span>&#123;</div><div class="line">        nodes[u].l = left;</div><div class="line">        nodes[u].r = right;</div><div class="line">        nodes[u].h = <span class="number">0</span>;</div><div class="line">        nodes[u].lazy = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">if</span>(left + <span class="number">1</span> == right) <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">int</span> mid = MID(left, right);</div><div class="line">        build(left, mid, L(u));</div><div class="line">        build(mid, right, R(u));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(<span class="keyword">int</span> u)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (!nodes[u].lazy) <span class="keyword">return</span>;</div><div class="line">		nodes[L(u)].h = max(nodes[L(u)].h, nodes[u].h);</div><div class="line">		nodes[R(u)].h = max(nodes[R(u)].h, nodes[u].h);</div><div class="line">		nodes[L(u)].lazy = nodes[R(u)].lazy = <span class="literal">true</span>;</div><div class="line">		nodes[u].h = <span class="number">-1</span>;</div><div class="line">		nodes[u].lazy = <span class="literal">false</span>;</div><div class="line">	&#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">(<span class="keyword">int</span> u)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(nodes[L(u)].h == nodes[R(u)].h) nodes[u].h = nodes[L(u)].h;</div><div class="line">        <span class="keyword">else</span> nodes[u].h = <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> right, <span class="keyword">int</span> u, <span class="keyword">int</span> height)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(nodes[u].l == left &amp;&amp; nodes[u].r == right &amp;&amp; nodes[u].h &gt;= <span class="number">0</span>)&#123;</div><div class="line">            <span class="keyword">if</span>(nodes[u].h == <span class="number">0</span>)&#123;</div><div class="line">                nodes[u].h = height;</div><div class="line">                nodes[u].lazy = <span class="literal">true</span>;</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(nodes[u].h &lt; height)&#123;</div><div class="line">                nodes[u].h = height;</div><div class="line">                nodes[u].lazy = <span class="literal">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        pushdown(u);</div><div class="line">        <span class="keyword">int</span> mid = MID(nodes[u].l, nodes[u].r);</div><div class="line">        <span class="keyword">if</span>(right &lt;= mid)&#123;</div><div class="line">            update(left, right, L(u), height);</div><div class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(left &gt;= mid)&#123;</div><div class="line">            update(left, right, R(u), height);</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            update(left, mid, L(u), height);</div><div class="line">            update(mid, right, R(u), height);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        pushup(u);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> &amp;right, <span class="keyword">int</span> u)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (nodes[u].l == left &amp;&amp; nodes[u].h &gt;= <span class="number">0</span>) &#123;</div><div class="line">			right = nodes[u].r;</div><div class="line">			<span class="keyword">return</span> nodes[u].h;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">int</span> mid = MID(nodes[u].l, nodes[u].r);</div><div class="line">		<span class="keyword">if</span> (left &gt;= mid) &#123;</div><div class="line">			<span class="keyword">return</span> query(left, right, R(u));</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> query(left, right, L(u));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    </div><div class="line">    <span class="built_in">vector</span>&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;&gt; getSkyline(<span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt;&amp; bs) &#123;</div><div class="line">        <span class="built_in">map</span>&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; m;</div><div class="line">        <span class="built_in">set</span>&lt;<span class="keyword">int</span>&gt; s;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> b : bs)&#123;</div><div class="line">            s.insert(b[<span class="number">0</span>]);</div><div class="line">            s.insert(b[<span class="number">1</span>]);</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; aux(s.begin(), s.end());</div><div class="line">        <span class="keyword">int</span> n = aux.size();</div><div class="line">        <span class="keyword">if</span>(n == <span class="number">0</span>) <span class="keyword">return</span> &#123;&#125;;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i ++) m[aux[i]] = i+<span class="number">1</span>;</div><div class="line">        </div><div class="line">        SegTree tree;</div><div class="line">        tree.build(<span class="number">1</span>, n+<span class="number">1</span>, <span class="number">1</span>);</div><div class="line">        </div><div class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> b : bs) tree.update(m[b[<span class="number">0</span>]], m[b[<span class="number">1</span>]], <span class="number">1</span>, b[<span class="number">2</span>]);</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> left = <span class="number">1</span>, right = <span class="number">-1</span>, pre = <span class="number">-1</span>;</div><div class="line">        <span class="built_in">vector</span>&lt;pair&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt;&gt; res;</div><div class="line">        <span class="keyword">while</span>(right &lt; n)&#123;</div><div class="line">            <span class="keyword">int</span> height = tree.query(left, right, <span class="number">1</span>);</div><div class="line">            <span class="keyword">if</span>(res.empty() || height != res.back().second) res.push_back(&#123;aux[left<span class="number">-1</span>], height&#125;);</div><div class="line">            </div><div class="line">            left = right;</div><div class="line">        &#125;</div><div class="line">        res.push_back(&#123;aux[right<span class="number">-1</span>], <span class="number">0</span>&#125;);</div><div class="line">        <span class="keyword">return</span> res;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://crazyxy.github.io/2016/10/19/LeetCode-38-Count-and-Say/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yan Xue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Crazyxy is Coding">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/19/LeetCode-38-Count-and-Say/" itemprop="url">LeetCode 38 - Count and Say</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-19T13:32:09+08:00">
                2016-10-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/19/LeetCode-38-Count-and-Say/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/10/19/LeetCode-38-Count-and-Say/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><blockquote>
<p>Just do it.</p>
</blockquote>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="function"><span class="built_in">string</span> <span class="title">countAndSay</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="built_in">string</span> res = <span class="string">"1"</span>;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i ++)&#123;</div><div class="line">            <span class="keyword">int</span> len = res.length();</div><div class="line">            <span class="keyword">int</span> j = <span class="number">0</span>;</div><div class="line">            <span class="built_in">string</span> tmp;</div><div class="line">            <span class="keyword">while</span>(j &lt; len)&#123;</div><div class="line">                <span class="keyword">int</span> k = j;</div><div class="line">                <span class="keyword">while</span>(k &lt; len &amp;&amp; res[k] == res[j]) k ++;</div><div class="line">                tmp += to_string(k - j) + res[j];</div><div class="line">                j = k;</div><div class="line">            &#125;</div><div class="line">            res = tmp;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> res;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://crazyxy.github.io/2016/10/19/LeetCode-56-Merge-Intervals/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yan Xue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Crazyxy is Coding">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/19/LeetCode-56-Merge-Intervals/" itemprop="url">LeetCode 56 - Merge Intervals</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-19T13:10:30+08:00">
                2016-10-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/19/LeetCode-56-Merge-Intervals/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/10/19/LeetCode-56-Merge-Intervals/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><blockquote>
<p>Just do it.</p>
</blockquote>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Definition for an interval.</div><div class="line"> * struct Interval &#123;</div><div class="line"> *     int start;</div><div class="line"> *     int end;</div><div class="line"> *     Interval() : start(0), end(0) &#123;&#125;</div><div class="line"> *     Interval(int s, int e) : start(s), end(e) &#123;&#125;</div><div class="line"> * &#125;;</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="built_in">vector</span>&lt;Interval&gt; merge(<span class="built_in">vector</span>&lt;Interval&gt;&amp; arr) &#123;</div><div class="line">        <span class="keyword">int</span> n = arr.size();</div><div class="line">        <span class="keyword">if</span>(!n) <span class="keyword">return</span> &#123;&#125;;</div><div class="line">        </div><div class="line">        sort(arr.begin(), arr.end(), [](<span class="keyword">const</span> Interval&amp; lhs, <span class="keyword">const</span> Interval&amp; rhs)&#123;</div><div class="line">            <span class="keyword">if</span>(lhs.start == rhs.start) <span class="keyword">return</span> lhs.end &lt; rhs.end;</div><div class="line">            <span class="keyword">return</span> lhs.start &lt; rhs.start;</div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> left = arr[<span class="number">0</span>].start, right = arr[<span class="number">0</span>].end;</div><div class="line">        <span class="built_in">vector</span>&lt;Interval&gt; res;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i ++)&#123;</div><div class="line">            <span class="keyword">if</span>(arr[i].start &lt;= right) right = max(right, arr[i].end);</div><div class="line">            <span class="keyword">else</span>&#123;</div><div class="line">                res.push_back(&#123;left, right&#125;);</div><div class="line">                left = arr[i].start;</div><div class="line">                right = arr[i].end;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        res.push_back(&#123;left, right&#125;);</div><div class="line">        <span class="keyword">return</span> res;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://crazyxy.github.io/2016/10/19/LeetCode-165-Compare-Version-Numbers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yan Xue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Crazyxy is Coding">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/19/LeetCode-165-Compare-Version-Numbers/" itemprop="url">LeetCode 165 - Compare Version Numbers</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-19T12:49:37+08:00">
                2016-10-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/19/LeetCode-165-Compare-Version-Numbers/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/10/19/LeetCode-165-Compare-Version-Numbers/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><blockquote>
<p>Just do it.</p>
</blockquote>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">compareVersion</span><span class="params">(<span class="built_in">string</span> version1, <span class="built_in">string</span> version2)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> m = version1.length(), n = version2.length(), i = <span class="number">0</span>, j = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>(i &lt; m &amp;&amp; j &lt; n)&#123;</div><div class="line">            <span class="keyword">int</span> ii = i, jj = j;</div><div class="line">            <span class="keyword">while</span>(ii &lt; m &amp;&amp; version1[ii] != <span class="string">'.'</span>) ii ++;</div><div class="line">            <span class="keyword">while</span>(jj &lt; n &amp;&amp; version2[jj] != <span class="string">'.'</span>) jj ++;</div><div class="line">            <span class="built_in">string</span> lhs = version1.substr(i, ii - i);</div><div class="line">            <span class="built_in">string</span> rhs = version2.substr(j, jj - j);</div><div class="line">            <span class="keyword">if</span>(stoi(lhs) &gt; stoi(rhs)) <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(stoi(lhs) &lt; stoi(rhs)) <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">            i = ii + <span class="number">1</span>;</div><div class="line">            j = jj + <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span>(i &gt;= m &amp;&amp; j &gt;= n) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(i &gt; m)&#123;</div><div class="line">            <span class="keyword">while</span>(j &lt; n &amp;&amp; (version2[j] == <span class="string">'.'</span> || version2[j] == <span class="string">'0'</span>)) j ++;</div><div class="line">            <span class="keyword">if</span>(j == n) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">while</span>(i &lt; m &amp;&amp; (version1[i] == <span class="string">'.'</span> || version1[i] == <span class="string">'0'</span>)) i ++;</div><div class="line">            <span class="keyword">if</span>(i == m) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://crazyxy.github.io/2016/10/19/LeetCode-258-Add-Digits/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yan Xue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Crazyxy is Coding">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/19/LeetCode-258-Add-Digits/" itemprop="url">LeetCode 258 - Add Digits</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-19T11:32:16+08:00">
                2016-10-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/19/LeetCode-258-Add-Digits/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/10/19/LeetCode-258-Add-Digits/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><blockquote>
<p>Just do it.</p>
</blockquote>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">addDigits</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> num % <span class="number">9</span> || !num ? num % <span class="number">9</span> : <span class="number">9</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-paypal"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yan Xue</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://crazyxy.disqus.com/count.js" async></script>
    

    

  




	





  





  








  





  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
